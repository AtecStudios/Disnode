<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>pluginmanager.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Tutorials</li><li class="nav-item"><a href="tutorial-NewDisnodePlugin.html">NewDisnodePlugin</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Bot.html">Bot</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#AddReaction">AddReaction</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#AddReaction">AddReaction</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#Ban">Ban</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#Connect">Connect</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#DeleteMessages">DeleteMessages</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#Disconnect">Disconnect</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#EditEmbed">EditEmbed</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#EditMessage">EditMessage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#GetBotInfo">GetBotInfo</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#GetMember">GetMember</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#GetMessage">GetMessage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#GetReaction">GetReaction</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#GetRoleById">GetRoleById</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#GetServerByID">GetServerByID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#GetUserByID">GetUserByID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#GetUserInfo">GetUserInfo</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#GetUserRoles">GetUserRoles</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#JoinUsersVoiceChannel">JoinUsersVoiceChannel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#JoinVoiceChannel">JoinVoiceChannel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#Kick">Kick</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#LeaveUsersVoiceChannel">LeaveUsersVoiceChannel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#LeaveVoiceChannel">LeaveVoiceChannel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#Mute">Mute</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#pageResults">pageResults</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#RemoveAllReactions">RemoveAllReactions</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#RemoveReaction">RemoveReaction</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#Restart">Restart</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#SendCompactEmbed">SendCompactEmbed</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#SendEmbed">SendEmbed</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#SendMessage">SendMessage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#SetServerName">SetServerName</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#SetStatus">SetStatus</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#SetUsername">SetUsername</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#Unban">Unban</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Bot.html#Unmute">Unmute</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Disnode.html">Disnode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Disnode.html#LoadBotConfig">LoadBotConfig</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Disnode.html#OnMessage">OnMessage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Disnode.html#Restart">Restart</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Disnode.html#Start">Start</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Disnode.html#Stop">Stop</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="PluginManager.html">PluginManager</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PluginManager.html#AddServerPluginLocal">AddServerPluginLocal</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PluginManager.html#AddServerPluginRemote">AddServerPluginRemote</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PluginManager.html#GetCommandFile">GetCommandFile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PluginManager.html#GetCommandObject">GetCommandObject</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PluginManager.html#GetCommandPrefixes">GetCommandPrefixes</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PluginManager.html#GetConfigFile">GetConfigFile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PluginManager.html#GetInstanceByID">GetInstanceByID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PluginManager.html#GetPluginByID">GetPluginByID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PluginManager.html#GetPluginFiles">GetPluginFiles</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PluginManager.html#GetScriptRequire">GetScriptRequire</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PluginManager.html#LaunchPlugin">LaunchPlugin</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PluginManager.html#LoadAllPlugins">LoadAllPlugins</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PluginManager.html#MakeServerFolder">MakeServerFolder</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PluginManager.html#RemoveServerPlugin">RemoveServerPlugin</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PluginManager.html#RunCommandBind">RunCommandBind</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PluginManager.html#RunPluginMessage">RunPluginMessage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PluginManager.html#SetCommandFile">SetCommandFile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PluginManager.html#SetConfigFile">SetConfigFile</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Util.html">Util</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Util.html#arrayToOject">arrayToOject</a></span></li><li class="nav-heading">Events</li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Bot.html#event:channel_create">channel_create</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Bot.html#event:channel_delete">channel_delete</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Bot.html#event:channel_update">channel_update</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Bot.html#event:guild_ban_add">guild_ban_add</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Bot.html#event:guild_ban_remove">guild_ban_remove</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Bot.html#event:guild_create">guild_create</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Bot.html#event:guild_delete">guild_delete</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Bot.html#event:guild_intergrations">guild_intergrations</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Bot.html#event:guild_memeber_add">guild_memeber_add</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Bot.html#event:guild_memeber_removed">guild_memeber_removed</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Bot.html#event:guild_role_created">guild_role_created</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Bot.html#event:guild_role_delete">guild_role_delete</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Bot.html#event:guild_role_update">guild_role_update</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Bot.html#event:guild_update">guild_update</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Bot.html#event:message">message</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Bot.html#event:message_delete">message_delete</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Bot.html#event:message_presence">message_presence</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Bot.html#event:message_update">message_update</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Bot.html#event:ready">ready</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Bot.html#event:setting_update">setting_update</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Bot.html#event:typing">typing</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Bot.html#event:voice_update">voice_update</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">pluginmanager.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var Logger = require("disnode-logger");
const async = require('async');
const fs = require('fs-extra')
const jsonfile = require('jsonfile');
const Stopwatch = require('timer-stopwatch');
const merge = require('merge');
const http = require('https');
const unzip = require('unzip2');
var npmi = require('npmi');
var path = require('path');

var timer = new Stopwatch();
/**
 * PluginManager Handle all Plugin Related Task
 * @constructor
 * @param {DisnodeObject} disnode - Disnode Refrence
 * @param {string} server - Server the PluginManager is on
 */
class PluginManager {
  constructor(disnode, server) {
    this.server = server;
    this.disnode = disnode;
    this.instances = [];
    this.plugins = [];

  }
  /**
   * Loads All Plugins for thie server (Core Plugins and Server Plugins
   */
  LoadAllPlugins() {
    var self = this;

    return new Promise(function (resolve, reject) {
      timer.start();
      self.instances.length = 0;
      self.plugins.length = 0;
      Logger.Info("PluginManager-" + self.server, "LoadAllPlugins", "Loading All Plugins!")

      async.waterfall([
        // Load Server Plugins
        function (cb) {
          self.GetPluginFiles("./servers/" + self.server, true).then(function (plugins) {

            if (!plugins) {
              cb();
              return
            }
            for (var i = 0; i &lt; plugins.length; i++) {
              self.SetupEvents(plugins[i]);
              self.plugins.push(plugins[i]);
              self.LaunchPlugin(plugins[i].id, {})
            }
            cb();
          })
        },
        function (cb) {
          //Load Default Plugins

          self.GetPluginFiles("./plugins/", false).then(function (plugins) {

            if (!plugins) {
              cb();
              return
            }

            for (var i = 0; i &lt; plugins.length; i++) {

              var alreadyAdded = false;
              //Run Check for alreadyAdded plugins
              for (var x = 0; x &lt; self.plugins.length; x++) {

                if (self.plugins[x].id == plugins[i].id) {
                  alreadyAdded = true;
                }
              }

              if (!alreadyAdded) {
                self.SetupEvents(plugins[i]);
                self.plugins.push(plugins[i]);
                if(plugins[i].launch){
                  self.LaunchPlugin(plugins[i].id, {})
                }
              }
            }
            cb();
          }).catch(cb);
        }
      ], function (err, res) {

        timer.stop();

        Logger.Success("PluginManager-" + self.server, "LoadAllPlugins", "Loaded " + self.plugins.length + " plugins in " + timer.ms + "ms!");
        timer.reset();
        resolve();
      })
    });
  }
  /**
   * Runs a Command to a plugin
   *
   * @param {string} pluginID - Plugin to run the command
   * @param {commandObject} commandObject - Command Object returned by CommandManager.js
   */
  RunPluginMessage(pluginID, commandObject) {

    var self = this;


    var plugin = self.GetInstanceByID(pluginID);

    if (!plugin) {
      self.LaunchPlugin(pluginID, commandObject).then(function (launched) {
        self.instances.push(launched);
        self.RunCommandBind(launched, commandObject);

      });
    } else {
      self.RunCommandBind(plugin, commandObject);

    }
  }
  /**
   * Launches a Plugin on a server
   * @param {string} pluginID - Plugin to launch
   * @param {commandObject} commandObject - Command Object returned by CommandManager.js
   */
  LaunchPlugin(pluginID, commandObject) {
    var self = this;
    Logger.Info("PluginManager-" + this.server, "LaunchPlugin", "Launching Plugin: " + pluginID);
    return new Promise(function (resolve, reject) {
      var pluginFile = self.GetPluginByID(pluginID);
      var _newPlugin = {};

      self.GetScriptRequire(pluginFile).then(function (requireClass) {
        pluginFile.disnode = self.disnode;
        pluginFile.pluginManager = self;
        pluginFile.server = self.server;
        _newPlugin = merge(new requireClass(), pluginFile);

        self.disnode.stats.pluginInstances++;
        return self.GetConfigFile(_newPlugin)
      }).then(function (config) {
        _newPlugin.config = config;
        return self.GetCommandFile(_newPlugin);
      }).then(function (commands) {
        _newPlugin.commands = commands;
        _newPlugin.Destory = function () {
          self.DestoryPlugin(_newPlugin.id);
        }
        if (_newPlugin.Init) {
          _newPlugin.Init(function () {

            resolve(_newPlugin);
          })
        } else {
          resolve(_newPlugin);
        }
      }).catch(function (err) {
        console.log(err);
        reject(err);
      })

    });
  }


  DestoryPlugin(pluginID) {
    var self = this;
    var i = self.instances.indexOf(pluginID);
    Logger.Success("PluginManager-" + this.server, "DestoryPlugin", "Destroyed Plugin Instance: " + pluginID);
    self.instances.splice(i, 1);
    self.disnode.stats.pluginInstances--;
  }
  /**
   * Runs a function in a plugin (bind)
   * @param {string} pluginID - Plugin to Run it
   * @param {commandObject} commandObject - Command Object returned by CommandManager.js
   */
  RunCommandBind(pluginID, commandObject) {

    var commandObj = this.GetCommandObject(pluginID, commandObject.command);

    if (!pluginID[commandObj.run]) {
      Logger.Warning("PluginManager-" + this.server, "RunCommandBind", "No Function Found for: " + commandObj.run);
      return;
    }
    if (commandObj.run == "default") {

      commandObject.params.unshift(commandObject.command);
    }


    pluginID[commandObj.run](commandObject);

  }
  RunPluginFunction(pluginId, toRun, commandObject) {
    var self = this;
    var plugin = self.GetInstanceByID(pluginId);
    if (!plugin) {
      self.LaunchPlugin(pluginId, commandObject).then(function (inst) {
        if (!inst[toRun]) {
          Logger.Warning("PluginManager-" + self.server, "RunPluginFunction", "No Function Found for: " + toRun);
          return;
        }


        inst[toRun](commandObject);
      });
      return;
    }
    if (!plugin[toRun]) {
      Logger.Warning("PluginManager-" + this.server, "RunPluginFunction", "No Function Found for: " + toRun);
      return;
    }


    plugin[toRun](commandObject);
  }
  SetupEvents(plugin) {
    var self = this;
    var bot = self.disnode.bot;
    var self = this;
    var bot = self.disnode.bot;

    if(plugin.events){
      for(var i=0;i&lt;plugin.events.length;i++){
        var cur = plugin.events[i];
        Logger.Success("PluginManager-" + self.server, "SetupEvents:" + plugin.id, "Listening for " + cur.event);
        bot.on(cur.event, function(data){
          self.RunPluginFunction(plugin.id, cur.run, {
            msg: data
          })
        })
      }
    }



  }

  ChangePluginConfig(plugin, key, val) {
    var self = this;
    return new Promise(function (resolve, reject) {

      //Plugin to edit

      var pluginClass = pluginManager.GetPluginByID(plugin);

      //Check if plugin is in Core or already added to server
      if (!pluginClass.isServer) {

        self.AddServerPluginLocal(plugin)
          .then(function () {
            pluginClass = pluginManager.GetPluginByID(plugin);
            return self.GetConfigFile(pluginClass);
          })

          .then(function (obj) {
            var newConfig = obj;

            newConfig[key] = val;

            return self.SetConfigFile(pluginClass, newConfig);
          })

          .then(function () {
            return self.LoadAllPlugins();
          })

          .then(function () {
            var command = self.disnode.server.GetCommandInstance(self.server);
            command.UpdateAllPrefixes();
            resolve();
          }).catch(reject);


      } else {

        self.GetConfigFile(plugin)
          .then(function (obj) {
            var newConfig = obj;

            newConfig[key] = val;

            return self.SetConfigFile(pluginClass, newConfig);
          })

          .then(function () {
            return self.LoadAllPlugins();
          })

          .then(function () {
            var command = self.disnode.server.GetCommandInstance(self.server);
            command.UpdateAllPrefixes();
            resolve();
          }).catch(reject);

      }
    });





  }
  /**
   * Adds/Downloads a Plugin to a server Folder
   * @param {string} pluginID - Plugin to Download and Add
   * @param {function} cb - Callback when Done
   */
  AddServerPluginRemote(pluginId, cb) {
    var self = this;
    return new Promise(function (resolve, reject) {
      self.command = self.disnode.server.GetCommandInstance(self.server);
      self.MakeServerFolder();
      var newPath = "servers/" + self.server;

      var request = http.get("https://www.disnodeteam.com/api/plugins/download/" + pluginId, function (response) {
        response.pipe(unzip.Extract({
          path: newPath
        }));
        response.on("end", function () {
          setTimeout(function () {
            self.LoadAllPlugins().then(function () {
              self.InstallPluginRequirements(pluginId).then(function () {
                self.command.UpdateAllPrefixes();
                resolve();
              })

            });


          }, 1000);
        })

      });
    });
  }
  /**
   * Adds a plugin from the Core Folder
   * @param {string} pluginID - Plugin to Download and Add
   * @param {function} cb - Callback when Done
   */
  AddServerPluginLocal(pluginId) {
    var self = this;
    console.log("Adding Local Plugin: " + pluginId)
    return new Promise(function (resolve, rejecy) {
      self.command = self.disnode.server.GetCommandInstance(self.server);
      self.MakeServerFolder();
      for (var i = 0; i &lt; self.plugins.length; i++) {
        if (self.plugins[i].isServer) {
          return;
        }

        if (self.plugins[i].id == pluginId) {
          var newPath = self.plugins[i].path.replace("plugins/", "servers/" + self.server);
          console.log(newPath);

          fs.copy(self.plugins[i].path, newPath, function (err) {
            if (err) return console.error(err)
            setTimeout(function () {
              self.LoadAllPlugins().then(function () {
                self.command.UpdateAllPrefixes();
                resolve();
              });

            }, 1000);
          });
        }
      }
    });
  }

  /**
   * Removes a Plugin frome a server Folder
   * @param {string} pluginID - Plugin to Download and Add
   */
  RemoveServerPlugin(pluginId) {
    var self = this;
    self.MakeServerFolder();
    for (var i = 0; i &lt; self.plugins.length; i++) {
      if (self.plugins[i].isServer == false) {

        return;
      }

      if (self.plugins[i].id == pluginId) {
        var newPath = self.plugins[i].path.replace("plugins/", "servers/" + this.server);

        fs.remove(self.plugins[i].path, err => {
          if (err) return console.error(err)
          this.LoadAllPlugins();

        })
      }

    }
  }

  InstallPluginRequirements(pluginId) {
    var self = this;
    return new Promise(function (resolve, reject) {
      var pluginObj = self.GetPluginByID(pluginId);

      if (pluginObj.requirements) {
        Logger.Info("PluginManager-" + self.server, "InstallPluginRequirements:" + pluginObj.id, "Installing Requirements: " + pluginObj.requirements);
        async.each(pluginObj.requirements, self.InstallPackage, function (err) {

          resolve();
        });

      } else {
        resolve();
      }
    });
  }

  InstallPackage(pack, callback) {
    var self = this;
    var options = {
      name: pack,
      forceInstall: false, // force install if set to true (even if already installed, it will do a reinstall) [default: false]
      npmLoad: { // npm.load(options, callback): this is the "options" given to npm.load()
        loglevel: 'warn' // [default: {loglevel: 'silent'}]
      }
    };
    npmi(options, function (err, result) {
      if (err) {
        callback();
        return;
      }

      // installed
      callback();
    });
  }
  /**
   * Creates a server specific folder for plugins
   * @param {string} pluginID - Plugin to Download and Add
   */
  MakeServerFolder() {
    var dir = "./servers/" + this.server;
    if (!fs.existsSync(dir)) {
      fs.mkdirSync(dir);
    }

  }
  /**
   * Gets a plugin object by ID
   * @param {string} pluginID - Plugin to Download and Add
   */
  GetPluginByID(pluginID) {
    for (var i = 0; i &lt; this.plugins.length; i++) {
      if (this.plugins[i].id == pluginID) {
        return this.plugins[i]
      }
    }
  }
  /**
   * Gets a plugin instance object by ID
   * @param {string} pluginID - Plugin to Download and Add
   */
  GetInstanceByID(pluginID) {
    for (var i = 0; i &lt; this.instances.length; i++) {

      if (this.instances[i].id == pluginID) {
        return this.instances[i]
      }
    }
  }
  /**
   * Gets all the plugin files (plugin.js) in a folder
   * @param {string} pluginID - Plugin to Download and Add
   */
  GetPluginFiles(path, isServer) {

    var self = this;
    return new Promise(function (resolve, reject) {
      var Plugins = [];
      var folders = ""
      try {
        folders = fs.readdirSync(path);
      } catch (e) {
        resolve();
      }


      async.each(folders, function (_folder, cb) {

        jsonfile.readFile(path + "/" + _folder + "/plugin.json", function (err, obj) {
          if (!err) {
            obj.path = path + "/" + _folder;
            obj.isServer = isServer;
            if (!obj.load) {
              Logger.Warning("PluginManager-" + self.server, "GetPluginFolders", "Not loading: " + _folder)
              cb();
              return
            }
            Plugins.push(obj);
            cb();
            return;
          } else {
            Logger.Warning("PluginManager-" + self.server, "GetPluginFolders", "Error Finding plugin.json file: " + _folder)
            cb();
            return;
          }
          cb();
        })

      }, function (err, res) {

        resolve(Plugins)
      })
    });

  }

  /**
   * Get all the prefixes
   * @param {string} pluginID - Plugin to Download and Add
   */
  GetCommandPrefixes() {
    var self = this;
    return new Promise(function (resolve, reject) {

      var prefix = [];

      async.each(self.plugins, function (plugin, cb) {

        self.GetConfigFile(plugin).then(function (config) {

          prefix.push({
            plugin: plugin.id,
            prefix: config.prefix
          });
          cb();
        }).catch(function (err) {

          cb(err);
        });
      }, function (err, res) {
        if (err) reject(err);

        resolve(prefix);
      })

    });
  }

  /**
   * Get all the prefixes
   * @param {string} pluginID - Plugin to Download and Add
   * @param {string} commandString - ?????
   */
  GetCommandObject(plugin, commandString) {
    var _cmds = plugin.commands || [];
    var _found;
    for (var i = 0; i &lt; _cmds.length; i++) {
      if (_cmds[i].cmd == commandString) {
        _found = _cmds[i];
      }
    }

    if (_found) {
      return _found;
    } else {
      return {
        cmd: commandString,
        run: "default"
      }
    }
  }

  /**
   * Get a plugin's config file
   * @param {string} pluginID - Plugin to get config file for
   */
  GetConfigFile(plugin) {
    return new Promise(function (resolve, reject) {
      if (!plugin.configFile) {
        reject("No Config Set");
        return;
      }

      jsonfile.readFile(plugin.path + "/" + plugin.configFile, function (err, obj) {
        if (err) {
          reject(err);
          return
        }
        resolve(obj);
      });
    });
  }

  /**
   * Get a plugin's command file
   * @param {string} pluginID - Plugin to get command file for
   */
  GetCommandFile(plugin) {
    return new Promise(function (resolve, reject) {
      if (!plugin.commandsFile) {
        reject("No Command Set");
        return;
      }

      jsonfile.readFile(plugin.path + "/" + plugin.commandsFile, function (err, obj) {
        if (err) {
          console.log(err);
          reject(err);
          return
        }

        resolve(obj.commands);
      });
    });
  }

  /**
   * Write to a plugins's config
   * @param {string} pluginID - Plugin to set config file for
   * @param {object} config - Plugin to set config file for
   */
  SetConfigFile(plugin, config) {
    return new Promise(function (resolve, reject) {
      if (!plugin.configFile) {
        reject("No Config Set");
        return;
      }

      jsonfile.writeFile(plugin.path + "/" + plugin.configFile, config, function (err) {
        if (err) {
          reject(err);
          return
        }
        resolve();
      });
    });
  }
  /**
   * Write to a plugins's command file
   * @param {string} pluginID - Plugin to set config file for
   * @param {object} commands - Plugin to set command file for
   */
  SetCommandFile(plugin, commands) {
    return new Promise(function (resolve, reject) {
      if (!plugin.commandsFile) {
        reject("No Command Set");
        return;
      }

      jsonfile.writeFile(plugin.path + "/" + plugin.commandsFile, commands, function (err) {
        if (err) {
          console.log(err);
          reject(err);
          return
        }

        resolve();
      });
    });
  }
  /**
   * Get the plugin class from the plugin.json file
   * @param {string} pluginID - Plugin to get
   */
  GetScriptRequire(plugin) {
    return new Promise(function (resolve, reject) {
      if (!plugin.script) {
        reject("No Script Set");
        return;
      }

      var className = plugin.script;
      var path = plugin.path + "/" + className;
      async.waterfall([
        // Check if class exists
        function (callback) {
          Logger.Info("PluginManager", "Load-" + plugin.name, "Checking for class");
          fs.stat(path, function (err, stats) {
            if (err) {
              Logger.Error("PluginManager", "Load-" + plugin.name, "Failed to find Class (" + path + ")");
              callback(err);
              return;
            } else {
              Logger.Success("PluginManager", "Load-" + plugin.name, "Found Class");
              callback();
            }
          });
        },
        // Attempt to import the class
        function (callback) {
          Logger.Info("PluginManager", "Load-" + plugin.name, "Trying to import class");
          try {
            var NpmRequire = require("../" + path);

            Logger.Success("PluginManager", "Load-" + plugin.name, "Imported");

            callback(null, NpmRequire);
          } catch (e) {
            Logger.Error("PluginManager", "Load-" + plugin.name, "Failed to Import: " + className + " - '" + e + "'");
            callback(e, null);
          }
        },
      ], function (err, result) {
        if (err) {
          console.log(err);
          reject(err);
          return;
        }

        resolve(result);

      });

    });
  }

}

module.exports = PluginManager;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Wed Jun 14 2017 13:35:23 GMT-0700 (Pacific Daylight Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
