<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>pluginmanager.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Bot.html">Bot</a><ul class='methods'><li data-type='method'><a href="Bot.html#Connect">Connect</a></li><li data-type='method'><a href="Bot.html#Disconnect">Disconnect</a></li><li data-type='method'><a href="Bot.html#EditEmbed">EditEmbed</a></li><li data-type='method'><a href="Bot.html#EditMessage">EditMessage</a></li><li data-type='method'><a href="Bot.html#Restart">Restart</a></li><li data-type='method'><a href="Bot.html#SendCompactEmbed">SendCompactEmbed</a></li><li data-type='method'><a href="Bot.html#SendEmbed">SendEmbed</a></li><li data-type='method'><a href="Bot.html#SendMessage">SendMessage</a></li><li data-type='method'><a href="Bot.html#SetServerName">SetServerName</a></li><li data-type='method'><a href="Bot.html#SetStatus">SetStatus</a></li><li data-type='method'><a href="Bot.html#SetUsername">SetUsername</a></li></ul></li><li><a href="Disnode.html">Disnode</a><ul class='methods'><li data-type='method'><a href="Disnode.html#LoadBotConfig">LoadBotConfig</a></li><li data-type='method'><a href="Disnode.html#OnMessage">OnMessage</a></li><li data-type='method'><a href="Disnode.html#Restart">Restart</a></li><li data-type='method'><a href="Disnode.html#Start">Start</a></li><li data-type='method'><a href="Disnode.html#Stop">Stop</a></li></ul></li><li><a href="PluginManager.html">PluginManager</a><ul class='methods'><li data-type='method'><a href="PluginManager.html#AddServerPlugin">AddServerPlugin</a></li><li data-type='method'><a href="PluginManager.html#GetCommandFile">GetCommandFile</a></li><li data-type='method'><a href="PluginManager.html#GetCommandObject">GetCommandObject</a></li><li data-type='method'><a href="PluginManager.html#GetCommandPrefixes">GetCommandPrefixes</a></li><li data-type='method'><a href="PluginManager.html#GetConfigFile">GetConfigFile</a></li><li data-type='method'><a href="PluginManager.html#GetInstanceByID">GetInstanceByID</a></li><li data-type='method'><a href="PluginManager.html#GetPluginByID">GetPluginByID</a></li><li data-type='method'><a href="PluginManager.html#GetPluginFiles">GetPluginFiles</a></li><li data-type='method'><a href="PluginManager.html#GetScriptRequire">GetScriptRequire</a></li><li data-type='method'><a href="PluginManager.html#LaunchPlugin">LaunchPlugin</a></li><li data-type='method'><a href="PluginManager.html#LoadAllPlugins">LoadAllPlugins</a></li><li data-type='method'><a href="PluginManager.html#MakeServerFolder">MakeServerFolder</a></li><li data-type='method'><a href="PluginManager.html#RemoveServerPlugin">RemoveServerPlugin</a></li><li data-type='method'><a href="PluginManager.html#RunCommandBind">RunCommandBind</a></li><li data-type='method'><a href="PluginManager.html#RunPluginMessage">RunPluginMessage</a></li><li data-type='method'><a href="PluginManager.html#SetCommandFile">SetCommandFile</a></li><li data-type='method'><a href="PluginManager.html#SetConfigFile">SetConfigFile</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">pluginmanager.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var Logger       = require("disnode-logger");
const async      = require('async');
const fs         = require('fs-extra')
const jsonfile   = require('jsonfile');
const Stopwatch  = require('timer-stopwatch');
const merge      = require('merge');
const http = require('http');
const unzip = require('unzip');

var timer = new Stopwatch();
/**
 * PluginManager Handle all Plugin Related Task
 * @constructor
 * @param {DisnodeObject} disnode - Disnode Refrence
 * @param {string} server - Server the PluginManager is on
 */
class PluginManager{
  constructor(disnode, server){
    this.server    = server;
    this.disnode   = disnode;
    this.instances = [];
    this.plugins   = [];

  }
  /**
   * Loads All Plugins for thie server (Core Plugins and Server Plugins
   */
  LoadAllPlugins(){
    var self = this;

    return new Promise(function(resolve, reject) {
      timer.start();
      self.instances.length = 0;
      self.plugins.length = 0;
      Logger.Info("PluginManager-"+self.server, "LoadAllPlugins", "Loading All Plugins!")

      async.waterfall([
        // Load Server Plugins
        function(cb){
          self.GetPluginFiles("./servers/"+self.server, true).then(function(plugins){

            if(!plugins){cb();return}
            for (var i = 0; i &lt; plugins.length; i++) {
              self.plugins.push(plugins[i]);

            }
            cb();
          })
        },
        function(cb){
        //Load Default Plugins

          self.GetPluginFiles("./plugins/",false).then(function(plugins){

            if(!plugins){cb();return}

            for (var i = 0; i &lt; plugins.length; i++) {

              var alreadyAdded = false;
              //Run Check for alreadyAdded plugins
              for (var x = 0; x &lt; self.plugins.length; x++) {

                if(self.plugins[x].id == plugins[i].id){
                  alreadyAdded = true;
                }
              }

              if(!alreadyAdded){
                self.plugins.push(plugins[i]);
              }
            }
            cb();
          }).catch(cb);
        }
      ], function(err, res){

        timer.stop();

        Logger.Success("PluginManager-"+self.server, "LoadAllPlugins", "Loaded "+ self.plugins.length + " plugins in " + timer.ms + "ms!");
        timer.reset();
        resolve();
      })
    });
  }
  /**
   * Runs a Command to a plugin
   *
   * @param {string} pluginID - Plugin to run the command
   * @param {commandObject} commandObject - Command Object returned by CommandManager.js
   */
  RunPluginMessage(pluginID, commandObject){

    var self = this;


    var plugin = self.GetInstanceByID(pluginID);

    if(!plugin){
      self.LaunchPlugin(pluginID, commandObject).then(function(launched){
        self.instances.push(launched);
        self.RunCommandBind(launched, commandObject);

      });
    }else{
      self.RunCommandBind(plugin, commandObject);

    }
  }
  /**
   * Launches a Plugin on a server
   * @param {string} pluginID - Plugin to launch
   * @param {commandObject} commandObject - Command Object returned by CommandManager.js
   */
  LaunchPlugin(pluginID, commandObject){
    var self = this;
    Logger.Info("PluginManager-" + this.server, "LaunchPlugin", "Launching Plugin: " + pluginID);
    return new Promise(function(resolve, reject) {
      var pluginFile = self.GetPluginByID(pluginID);
      var _newPlugin = {};

      self.GetScriptRequire(pluginFile).then(function(requireClass){
        pluginFile.disnode = self.disnode;
        pluginFile.pluginManager = self;
        pluginFile.server = self.server;
        _newPlugin = merge(new requireClass(), pluginFile);


        return self.GetConfigFile(_newPlugin)
      }).then(function(config){
        _newPlugin.config = config;
        return self.GetCommandFile(_newPlugin);
      }).then(function(commands){
        _newPlugin.commands =commands;

        if(_newPlugin.Init){
          _newPlugin.Init(function(){
            resolve(_newPlugin);
          })
        }else{
          resolve(_newPlugin);
        }
      }).catch(function(err){
        console.log(err);
        reject(err);
      })

    });
  }
  /**
   * Runs a function in a plugin (bind)
   * @param {string} pluginID - Plugin to Run it
   * @param {commandObject} commandObject - Command Object returned by CommandManager.js
   */
  RunCommandBind(pluginID, commandObject){

    var commandObj = this.GetCommandObject(pluginID, commandObject.command);

    if(!pluginID[commandObj.run]){
      Logger.Warning("PluginManager-" + this.server, "RunCommandBind", "No Function Found for: " + commandObj.run);
      return;
    }
    pluginID[commandObj.run](messageObject);

  }
  /**
   * Adds/Downloads a Plugin to a server Folder
   * @param {string} pluginID - Plugin to Download and Add
   * @param {function} cb - Callback when Done
   */
  AddServerPlugin(pluginId, cb){
    var self = this;
    return new Promise(function(resolve, reject) {
      self.command   = self.disnode.server.GetCommandInstance(self.server);
      self.MakeServerFolder();
      var newPath ="servers/"+self.server;

      var request = http.get("http://www.disnodeteam.com/api/plugins/download/"+pluginId, function(response) {
        response.pipe(unzip.Extract({ path: newPath }));
        response.on("end", function(){
        setTimeout(function () {
          self.LoadAllPlugins().then(function(){
            self.command.UpdateAllPrefixes();
            resolve();
          });

         }, 1000);
       })

     });
    });
  }
  /**
   * Removes a Plugin frome a server Folder
   * @param {string} pluginID - Plugin to Download and Add
   */
  RemoveServerPlugin(pluginId){
    var self = this;
    self.MakeServerFolder();
    for (var i = 0; i &lt; self.plugins.length; i++) {
     if(self.plugins[i].isServer == false){

       return;
     }

     if(self.plugins[i].id == pluginId){
       var newPath =self.plugins[i].path.replace("plugins/", "servers/"+this.server);


       fs.remove(self.plugins[i].path, err => {
       	if (err) return console.error(err)
        this.LoadAllPlugins();

       })
     }

    }
  }
  /**
   * Creates a server specific folder for plugins
   * @param {string} pluginID - Plugin to Download and Add
   */
  MakeServerFolder(){
    var dir = "./servers/"+this.server;
    if (!fs.existsSync(dir)){
      fs.mkdirSync(dir);
    }

  }
  /**
   * Gets a plugin object by ID
   * @param {string} pluginID - Plugin to Download and Add
   */
  GetPluginByID(pluginID){
    for (var i = 0; i &lt; this.plugins.length; i++) {
      if(this.plugins[i].id == pluginID){return this.plugins[i]}
    }
  }
  /**
   * Gets a plugin instance object by ID
   * @param {string} pluginID - Plugin to Download and Add
   */
  GetInstanceByID(pluginID){
    for (var i = 0; i &lt; this.instances.length; i++) {

      if(this.instances[i].id == pluginID){return this.instances[i]}
    }
  }
  /**
   * Gets all the plugin files (plugin.js) in a folder
   * @param {string} pluginID - Plugin to Download and Add
   */
  GetPluginFiles(path, isServer){

    var self = this;
    return new Promise(function(resolve, reject) {
      var Plugins = [];
      var folders= ""
      try {
        folders = fs.readdirSync(path);
      } catch (e) {
        resolve();
      }


      async.each(folders, function(_folder, cb){

        jsonfile.readFile(path + "/" + _folder + "/plugin.json", function(err,obj){
          if(!err){
            obj.path = path + "/" + _folder;
            obj.isServer = isServer;

            Plugins.push(obj);
            cb();
            return;
          }else{
            Logger.Warning("PluginManager-"+self.server, "GetPluginFolders", "Error Finding plugin.json file: " + _folder)
            cb();
            return;
          }
          cb();
        })

      }, function(err, res){

        resolve(Plugins)
      })
    });

  }

  /**
   * Get all the prefixes
   * @param {string} pluginID - Plugin to Download and Add
   */
  GetCommandPrefixes(){
    var self = this;
    return new Promise(function(resolve, reject) {

      var prefix = [];

      async.each(self.plugins, function(plugin,cb){

        self.GetConfigFile(plugin).then(function(config){

          prefix.push({plugin: plugin.id, prefix: config.prefix});
          cb();
        }).catch(function(err){

          cb(err);
        });
      }, function(err, res){
        if (err) reject(err);

        resolve(prefix);
      })

    });
  }

  /**
   * Get all the prefixes
   * @param {string} pluginID - Plugin to Download and Add
   * @param {string} commandString - ?????
   */
  GetCommandObject(plugin, commandString){
    var _cmds = plugin.commands || [];
    var _found;
    for (var i = 0; i &lt; _cmds.length; i++) {
      if(_cmds[i].cmd == commandString){
        _found = _cmds[i];
      }
    }

    if(_found){
      return _found;
    }else{
      return {cmd: commandString, run: "default"}
    }
  }

  /**
   * Get a plugin's config file
   * @param {string} pluginID - Plugin to get config file for
   */
  GetConfigFile(plugin){
    return new Promise(function(resolve, reject) {
      if(!plugin.configFile){
        reject("No Config Set");
        return;
      }

      jsonfile.readFile(plugin.path + "/"+plugin.configFile, function(err, obj){
        if(err){
          reject(err);
          return
        }
        resolve(obj);
      });
    });
  }

  /**
   * Get a plugin's command file
   * @param {string} pluginID - Plugin to get command file for
   */
  GetCommandFile(plugin){
    return new Promise(function(resolve, reject) {
      if(!plugin.commandsFile){
        reject("No Command Set");
        return;
      }

      jsonfile.readFile(plugin.path + "/"+plugin.commandsFile, function(err, obj){
        if(err){
          console.log(err);
          reject(err);
          return
        }

        resolve(obj.commands);
      });
    });
  }

  /**
   * Write to a plugins's config
   * @param {string} pluginID - Plugin to set config file for
   * @param {object} config - Plugin to set config file for
   */
  SetConfigFile(plugin, config){
    return new Promise(function(resolve, reject) {
      if(!plugin.configFile){
        reject("No Config Set");
        return;
      }

      jsonfile.writeFile(plugin.path + "/"+plugin.configFile, config, function(err){
        if(err){
          reject(err);
          return
        }
        resolve();
      });
    });
  }
  /**
   * Write to a plugins's command file
   * @param {string} pluginID - Plugin to set config file for
   * @param {object} commands - Plugin to set command file for
   */
  SetCommandFile(plugin, commands){
    return new Promise(function(resolve, reject) {
      if(!plugin.commandsFile){
        reject("No Command Set");
        return;
      }

      jsonfile.writeFile(plugin.path + "/"+plugin.commandsFile, commands, function(err){
        if(err){
          console.log(err);
          reject(err);
          return
        }

        resolve();
      });
    });
  }
  /**
   * Get the plugin class from the plugin.json file
   * @param {string} pluginID - Plugin to get
   */
  GetScriptRequire(plugin){
    return new Promise(function(resolve, reject) {
      if(!plugin.script){
        reject("No Script Set");
        return;
      }

      var className = plugin.script;
      var path = plugin.path + "/" + className;
      async.waterfall([
          // Check if class exists
          function(callback) {
              Logger.Info("PluginManager", "Load-"+plugin.name, "Checking for class");
              fs.stat(path, function(err, stats) {
                  if (err) {
                      Logger.Error("PluginManager", "Load-"+plugin.name, "Failed to find Class (" + path + ")");
                      callback(err);
                      return;
                  } else {
                      Logger.Success("PluginManager", "Load-"+plugin.name, "Found Class");
                      callback();
                  }
              });
          },
          // Attempt to import the class
          function(callback) {
            Logger.Info("PluginManager", "Load-"+plugin.name, "Trying to import class");
              try {
                  var NpmRequire = require("../" + path);

                  Logger.Success("PluginManager", "Load-"+plugin.name, "Imported");

                  callback(null,NpmRequire);
              } catch (e) {
                Logger.Error("PluginManager", "Load-"+plugin.name, "Failed to Import: " + className + " - '" + e  + "'");
                callback(e, null);
              }
          },
      ], function(err, result) {
          if(err){
            console.log(err);
            reject(err);
            return;
          }

          resolve(result);

      });

    });
  }

}

module.exports = PluginManager;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Sat May 13 2017 15:22:35 GMT-0700 (Pacific Daylight Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
